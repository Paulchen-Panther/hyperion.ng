name: Hyperion CI/PR Builds
run-name: |
  ${{ github.event_name == 'pull_request' && 'ðŸ“¦ Generate artifacts for PR' || '' }}
  ${{ github.event_name == 'pull_request' && github.event.pull_request.number || '' }}
  ${{ github.event_name == 'pull_request' && '-' || '' }}
  ${{ github.event_name == 'push' && 'ðŸŒ± Push Build -' || '' }}
  ${{ github.event_name == 'pull_request' && github.event.pull_request.title || github.event.head_commit.message }}

on:
  push:
    branches:
      - '**'
    tags:
      - '*'
  pull_request:
    branches:
      - 'master'

# Cancel running actions when a new action on the same PR is started
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:

####################################
###### Qt 5 reusable workflow ######
####################################

  qt5_build:
    name: Qt 5 Build
    uses: ./.github/workflows/qt5.yml
    secrets: inherit
    with:
      event_name: ${{ github.event_name }}
      pull_request_number: ${{ github.event.pull_request.number }}
      publish: ${{ startsWith(github.event.ref, 'refs/tags') }}

####################################
###### Qt 6 reusable workflow ######
####################################

  qt6_build:
    name: Qt 6 Build (Testing)
    uses: ./.github/workflows/qt6.yml
    secrets: inherit
    with:
      event_name: ${{ github.event_name }}
      pull_request_number: ${{ github.event.pull_request.number }}

###################################
###### APT reusable workflow ######
###################################

  apt_build:
    name: APT Build
    if: startsWith(github.event.ref, 'refs/tags')
    needs: [qt5_build, qt6_build]
    uses: ./.github/workflows/apt.yml
    secrets: inherit
    with:
      nightly: false
      publish: true

###################################
###### DNF reusable workflow ######
###################################

  dnf_build:
    name: DNF Build
    if: startsWith(github.event.ref, 'refs/tags')
    needs: [qt5_build, qt6_build]
    uses: ./.github/workflows/dnf.yml
    secrets: inherit
    with:
      nightly: false
      publish: true
